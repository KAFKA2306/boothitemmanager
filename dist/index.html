<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoothList - BOOTH Asset Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
        .search-bar { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px; margin-bottom: 20px; }
        .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; }
        .filter.active { background: #007acc; color: white; }
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .item-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white; transition: box-shadow 0.2s; }
        .item-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .item-image { width: 100%; height: 150px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: #666; }
        .item-title { font-weight: bold; margin-bottom: 5px; color: #333; }
        .item-shop { color: #666; font-size: 14px; margin-bottom: 5px; }
        .item-price { color: #007acc; font-weight: bold; }
        .item-targets { margin-top: 10px; }
        .target-tag { display: inline-block; background: #e7f3ff; color: #007acc; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin: 2px; }
        .loading { text-align: center; padding: 50px; color: #666; }
        .stats { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; min-width: 120px; }
        .stat-number { font-size: 24px; font-weight: bold; color: #007acc; }
        .stat-label { font-size: 14px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>BoothList - BOOTH Asset Dashboard</h1>
        <div class="stats" id="stats">
            <div class="stat-card"><div class="stat-number" id="total-items">-</div><div class="stat-label">Total Items</div></div>
            <div class="stat-card"><div class="stat-number" id="total-variants">-</div><div class="stat-label">Variants</div></div>
            <div class="stat-card"><div class="stat-number" id="total-shops">-</div><div class="stat-label">Shops</div></div>
            <div class="stat-card"><div class="stat-number" id="total-value">-</div><div class="stat-label">Total Value</div></div>
        </div>
        <input type="text" class="search-bar" id="search" placeholder="Search items, shops, avatars...">
        <div class="filters" id="filters"><div class="filter active" data-type="all">All</div></div>
        <div class="loading" id="loading">Loading catalog...</div>
        <div class="items-grid" id="items" style="display: none;"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script>
        let allItems = [], filteredItems = [], activeFilter = 'all';
        async function loadData() {
            try {
                const [cRes, mRes] = await Promise.all([fetch('catalog.yml'), fetch('metrics.yml')]);
                const cYaml = await cRes.text();
                const mYaml = await mRes.text();
                const catalog = jsyaml.load(cYaml);
                const metrics = jsyaml.load(mYaml);
                allItems = catalog.items || [];
                updateStats(metrics);
                setupFilters();
                filterItems();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('items').style.display = 'grid';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = 'Error loading data. Please ensure catalog.yml and metrics.yml are available.';
            }
        }
        function updateStats(metrics) {
            const sum = metrics.summary || {};
            const ps = sum.price_stats || {};
            document.getElementById('total-items').textContent = sum.items_total || 0;
            document.getElementById('total-variants').textContent = sum.variants_total || 0;
            document.getElementById('total-shops').textContent = sum.shops_total || 0;
            document.getElementById('total-value').textContent = ps.total_value ? `¥${ps.total_value.toLocaleString()}` : '-';
        }
        function setupFilters() {
            // Standard Type Filters
            const types = new Set(['all']);
            allItems.forEach(item => types.add(item.type));
            const container = document.getElementById('filters');
            container.innerHTML = '';
            
            // Usage Filters (New)
            const usageFilters = [
                { id: 'all', label: 'All Items' },
                { id: 'direct', label: 'Direct Use (Owned)' },
                { id: 'mochi', label: 'Mochifitter Use' },
                { id: 'orphaned', label: 'Orphaned' }
            ];
            
            usageFilters.forEach(f => {
                 const div = document.createElement('div');
                 div.className = 'filter' + (activeFilter === f.id ? ' active' : '');
                 div.textContent = f.label;
                 div.dataset.type = f.id;
                 div.addEventListener('click', () => setFilter(f.id));
                 container.appendChild(div);
            });
            
            // Separator
             const sep = document.createElement('div');
             sep.style.width = '100%';
             sep.style.height = '1px';
             sep.style.background = '#ddd';
             sep.style.margin = '10px 0';
             container.appendChild(sep);

            types.forEach(type => {
                if (type === 'all') return; // Handled above
                const div = document.createElement('div');
                div.className = 'filter' + (activeFilter === type ? ' active' : '');
                div.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                div.dataset.type = type;
                div.addEventListener('click', () => setFilter(type));
                container.appendChild(div);
            });
        }

        function setFilter(type) {
            activeFilter = type;
            document.querySelectorAll('.filter').forEach(f => {
                f.classList.remove('active');
                if (f.dataset.type === type) f.classList.add('active');
            });
            filterItems();
        }

        function filterItems() {
            const term = document.getElementById('search').value.toLowerCase();
            filteredItems = allItems.filter(item => {
                let matchFilter = true;
                if (activeFilter === 'all') {
                    matchFilter = true;
                } else if (activeFilter === 'direct') {
                    matchFilter = item.tags && item.tags.includes('owned_support');
                } else if (activeFilter === 'mochi') {
                    matchFilter = item.tags && item.tags.includes('mochifitter_support');
                } else if (activeFilter === 'orphaned') {
                    matchFilter = item.tags && item.tags.includes('orphaned_support');
                } else {
                    // Type filter
                    matchFilter = item.type === activeFilter;
                }

                const matchSearch = !term || item.name.toLowerCase().includes(term) 
                    || (item.shop_name && item.shop_name.toLowerCase().includes(term)) 
                    || (item.targets && item.targets.some(t => t.name.toLowerCase().includes(term) || t.code.toLowerCase().includes(term)));
                
                return matchFilter && matchSearch;
            });
            renderItems();
        }
        function renderItems() {
            const container = document.getElementById('items');
            if (filteredItems.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #666;">No items found</div>';
                return;
            }
            container.innerHTML = filteredItems.map(item => `
                <div class="item-card">
                    <div class="item-image">${item.image_url ? `<img src="${item.image_url}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">` : 'No Image'}</div>
                    <div class="item-title"><a href="${item.url}" target="_blank" style="text-decoration: none; color: inherit;">${item.name}</a></div>
                    <div class="item-shop">${item.shop_name || 'Unknown Shop'}</div>
                    <div class="item-price">${item.current_price !== null && item.current_price !== undefined ? (item.current_price === 0 ? 'Free' : `¥${item.current_price.toLocaleString()}`) : 'Price Unknown'}</div>
                    ${item.targets && item.targets.length > 0 ? `<div class="item-targets">${item.targets.map(target => `<span class="target-tag">${target.name}</span>`).join('')}</div>` : ''}
                </div>
            `).join('');
        }
        document.getElementById('search').addEventListener('input', filterItems);
        loadData();
    </script>
</body>
</html>